<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>...wayne...</title>
    <style>
        :root {
            --text: #f0ede8;
            --border: rgba(255,255,255,0.1);
            --card-bg: rgba(10,10,10,0.55);
        }
        * { box-sizing: border-box; }
        body {
            font-family: -apple-system, system-ui, sans-serif;
            background: #0a0a0a; color: var(--text);
            margin: 0; padding-bottom: 60vh;
        }
        #bg-canvas {
            position: fixed; top: 0; left: 0;
            width: 100dvw; height: 100dvh;
            z-index: 0; pointer-events: none;
        }
        #wrapper, #log-monitor, #color-modal-overlay { position: relative; z-index: 1; }

        /* MONITOR */
        #log-monitor {
            position: fixed; bottom: 20px; right: 20px; width: 280px;
            background: rgba(5,5,5,0.88); backdrop-filter: blur(12px);
            padding: 16px; border: 1px solid var(--border);
            border-radius: 12px; z-index: 1000; font-family: monospace; font-size: 11px;
            box-shadow: 0 15px 35px rgba(0,0,0,0.5); color: var(--text);
        }
        .config-row { display: flex; justify-content: space-between; margin-bottom: 5px; align-items: center; }
        .config-row input {
            width: 55px; font-size: 10px;
            background: rgba(255,255,255,0.06); border: 1px solid var(--border);
            color: var(--text); border-radius: 4px; padding: 2px 4px;
        }
        .btn-monitor {
            width: 100%; margin-top: 10px;
            background: rgba(255,255,255,0.07); color: var(--text);
            border: 1px solid var(--border); border-radius: 6px;
            padding: 6px; cursor: pointer; font-size: 11px; font-family: monospace;
            transition: background 0.2s;
        }
        .btn-monitor:hover { background: rgba(255,255,255,0.15); }

        /* MODAL */
        #color-modal-overlay {
            display: none; position: fixed; inset: 0; z-index: 2000;
            background: rgba(0,0,0,0.72); backdrop-filter: blur(6px);
            align-items: center; justify-content: center;
        }
        #color-modal-overlay.open { display: flex; }
        #color-modal {
            background: #0d0d0d; border: 1px solid rgba(255,255,255,0.15);
            border-radius: 16px; padding: 28px; width: 340px; max-height: 80vh;
            overflow-y: auto; font-family: monospace; color: var(--text);
            box-shadow: 0 30px 60px rgba(0,0,0,0.8);
        }
        #color-modal h3 { margin: 0 0 18px; font-size: 12px; letter-spacing: 0.12em; opacity: 0.45; font-weight: normal; text-transform: uppercase; }
        .csec { font-size: 9px; letter-spacing: 0.14em; opacity: 0.35; text-transform: uppercase; margin: 14px 0 8px; }
        .color-row { display: flex; align-items: center; justify-content: space-between; margin-bottom: 9px; gap: 10px; }
        .color-row label { font-size: 11px; flex: 1; opacity: 0.8; }
        .color-row input[type="color"] {
            width: 36px; height: 24px; border: none; border-radius: 4px;
            cursor: pointer; padding: 0; background: none;
        }
        .modal-actions { display: flex; gap: 8px; margin-top: 20px; }
        .modal-actions button {
            flex: 1; padding: 8px; border-radius: 8px; cursor: pointer;
            font-size: 11px; font-family: monospace; border: 1px solid var(--border);
            transition: background 0.2s;
        }
        #btn-copy-colors { background: rgba(255,255,255,0.1); color: var(--text); }
        #btn-copy-colors:hover { background: rgba(255,255,255,0.2); }
        #btn-close-modal { background: transparent; color: rgba(255,255,255,0.4); }
        #btn-close-modal:hover { background: rgba(255,255,255,0.05); }
        #copy-feedback {
            font-size: 10px; color: #4ade80; margin-top: 8px;
            text-align: center; height: 14px; opacity: 0; transition: opacity 0.3s;
        }
        #copy-feedback.show { opacity: 1; }

        /* INSTÃ‚NCIAS */
        .instancia-container {
            min-height: 85vh; display: flex; align-items: center; justify-content: center;
            padding: 40px; border-bottom: 1px solid var(--border);
            opacity: 0.2; transition: opacity 0.4s;
        }
        .commited .instancia-container { opacity: 1; }
        /* CTAs sempre visÃ­veis â€” visual leve, aguenta sem foco */
        .instancia-container.cta-inst { opacity: 1; }

        /* CTA â€” display tipogrÃ¡fico editorial */
        .cta-display {
            width: 100%; max-width: 680px; padding: 0 20px;
        }
        .cta-display .cta-eyebrow {
            font-size: 0.65rem; letter-spacing: 0.22em; opacity: 0.3;
            text-transform: uppercase; margin-bottom: 18px; font-family: monospace;
        }
        .cta-display h2 {
            font-size: clamp(3.5rem, 10vw, 7rem); font-weight: 200;
            letter-spacing: -0.03em; line-height: 0.95; margin: 0 0 24px;
            color: var(--text);
        }
        .cta-display .cta-sub {
            font-size: 0.85rem; opacity: 0.35; letter-spacing: 0.06em;
            margin-bottom: 36px; line-height: 1.6;
        }
        .cta-display .cta-action {
            display: inline-flex; align-items: center; gap: 10px;
            font-size: 0.75rem; letter-spacing: 0.14em; text-transform: uppercase;
            opacity: 0.55; cursor: pointer; transition: opacity 0.2s;
            background: none; border: none; color: var(--text); padding: 0;
        }
        .cta-display .cta-action:hover { opacity: 1; }
        .cta-display .cta-action .arr { font-size: 1.1rem; transition: transform 0.2s; }
        .cta-display .cta-action:hover .arr { transform: translateX(5px); }
        .cta-display .cta-links {
            display: flex; gap: 28px; flex-wrap: wrap; margin-top: 8px;
        }
        .cta-display .cta-links a {
            font-size: 0.75rem; letter-spacing: 0.1em; text-transform: uppercase;
            color: var(--text); text-decoration: none; opacity: 0.4;
            transition: opacity 0.2s; border-bottom: 1px solid rgba(255,255,255,0.12);
            padding-bottom: 2px;
        }
        .cta-display .cta-links a:hover { opacity: 0.9; }

        /* ARTE â€” sÃ³ imagem, sem tÃ­tulo */
        .art-card {
            width: min(80vw, 520px); aspect-ratio: 1 / 1;
            border-radius: 4px; overflow: hidden; position: relative;
        }
        .art-placeholder {
            width: 100%; height: 100%;
            background: rgba(255,255,255,0.04);
            display: flex; align-items: center; justify-content: center;
            position: relative; overflow: hidden;
        }
        .art-placeholder::before {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(
                45deg,
                transparent, transparent 18px,
                rgba(255,255,255,0.02) 18px, rgba(255,255,255,0.02) 19px
            );
        }
        .art-placeholder .art-id {
            font-family: monospace; font-size: 0.65rem;
            letter-spacing: 0.15em; opacity: 0.18; text-transform: uppercase;
        }

        /* PROJETO â€” mÃ­dia 16:9 + texto */
        .proj-card {
            width: min(80vw, 600px);
        }
        .proj-media {
            width: 100%; aspect-ratio: 16 / 9; border-radius: 8px;
            overflow: hidden; position: relative; margin-bottom: 24px;
            background: rgba(255,255,255,0.04);
        }
        .proj-media::before {
            content: ''; position: absolute; inset: 0;
            background: repeating-linear-gradient(
                -45deg,
                transparent, transparent 22px,
                rgba(255,255,255,0.02) 22px, rgba(255,255,255,0.02) 23px
            );
        }
        .proj-media .media-label {
            position: absolute; inset: 0; display: flex; align-items: center;
            justify-content: center; gap: 10px;
        }
        .proj-media .media-icon {
            width: 40px; height: 40px; border-radius: 50%;
            border: 1px solid rgba(255,255,255,0.15);
            display: flex; align-items: center; justify-content: center;
            font-size: 14px; opacity: 0.3;
        }
        .proj-info { padding: 0 4px; }
        .proj-info .proj-eyebrow {
            font-family: monospace; font-size: 0.62rem;
            letter-spacing: 0.16em; opacity: 0.3; text-transform: uppercase;
            margin-bottom: 8px;
        }
        .proj-info h3 {
            font-size: 1.4rem; font-weight: 300; margin: 0 0 10px;
            letter-spacing: -0.01em;
        }
        .proj-info p {
            font-size: 0.82rem; color: rgba(240,237,232,0.38);
            line-height: 1.65; margin: 0;
        }

        /* HERO */
        #sobre-mim .cta-display h2 {
            font-weight: 900;
        }
        .bar-fill { height: 100%; background: rgba(255,255,255,0.5); transition: width 0.3s; }
    </style>
</head>
<body>

<canvas id="bg-canvas"></canvas>

<!-- MODAL DE CORES -->
<div id="color-modal-overlay">
    <div id="color-modal">
        <h3>â¬¡ Color Map Editor</h3>

        <div class="csec">grupos principais</div>
        <div class="color-row"><label>Hero / Repouso (ctas)</label>    <input type="color" id="col-ctas"></div>
        <div class="color-row"><label>Contatos</label>                 <input type="color" id="col-CONTATOS"></div>
        <div class="color-row"><label>â†’ CTA Sketchbook</label>         <input type="color" id="col-GO_DESENHOS"></div>
        <div class="color-row"><label>â†’ CTA Portfolio</label>          <input type="color" id="col-GO_PROJETOS"></div>

        <div class="csec">desenhos (todos os D3.N herdam)</div>
        <div class="color-row"><label>Desenhos</label>                 <input type="color" id="col-desenhos"></div>

        <div class="csec">projetos (todos os P4.N herdam)</div>
        <div class="color-row"><label>Projetos</label>                 <input type="color" id="col-projetos"></div>

        <div class="modal-actions">
            <button id="btn-copy-colors">ðŸ“‹ Copiar COLOR_MAP</button>
            <button id="btn-close-modal">Fechar</button>
        </div>
        <div id="copy-feedback">copiado pro clipboard âœ“</div>
    </div>
</div>

<!-- MONITOR -->
<div id="log-monitor" style="visibility: hidden;">
    <strong style="opacity:0.5; font-size:10px; letter-spacing:0.1em">GGUI CONTROL PANEL v7.0</strong>
    <hr style="border-color:var(--border); margin:8px 0">
    <div class="config-row"><span>Decay (ms):</span>    <input type="number" id="cfg-decay" value="10000"></div>
    <div class="config-row"><span>Linear Speed:</span>  <input type="number" id="cfg-speed" step="0.1" value="0.1"></div>
    <div class="config-row"><span>Focus Share %:</span> <input type="number" id="cfg-share" value="85"></div>
    <hr style="border-color:var(--border); margin:8px 0">
    <strong>EM FOCO:</strong> <span id="current-focus">HERO</span><br>
    <strong>PRÃ“XIMO:</strong> <span id="next-label">--</span><br>
    <strong>DECAY EM:</strong> <span id="decay-timer">--</span>s
    <div id="prob-list" style="margin-top:12px;"></div>
    <button class="btn-monitor" onclick="openColorModal()">ðŸŽ¨ Editar cores do shader</button>
</div>

<div id="wrapper">
    <section id="sobre-mim" class="instancia-container" data-color-key="ctas" style="opacity:1;">
        <div class="cta-display">
            <div class="cta-eyebrow" id="hero-eyebrow">â€”</div>
            <h2 id="hero-greeting"></h2>
            <div class="cta-sub">essa experiÃªncia foi desenhada<br>e desenvolvida por wAyne</div>
        </div>
    </section>
    <div id="timeline"></div>
    <div id="candidate-area"></div>
</div>

<script>
// =============================================
// SAUDAÃ‡ÃƒO DINÃ‚MICA
// =============================================
(function() {
    const h = new Date().getHours();
    let greeting, eyebrow;
    if (h >= 5 && h < 12) {
        greeting = 'bom<br>dia';
        eyebrow = '';
    } else if (h >= 12 && h < 18) {
        greeting = 'boa<br>tarde';
        eyebrow = '';
    } else {
        greeting = 'boa<br>noite';
        eyebrow = '';
    }
    document.getElementById('hero-greeting').innerHTML = greeting;
    document.getElementById('hero-eyebrow').textContent = eyebrow;
})();

// =============================================
// COLOR MAP
// =============================================
const DEFAULT_COLORS = {
    'ctas': '#45f287',
    'CONTATOS': '#8aa1ff',
    'GO_DESENHOS': '#13e75d',
    'GO_PROJETOS': '#374fae',
    'desenhos': '#257e43',
    'projetos': '#293460',
};

function loadColors() {
    try {
        const s = localStorage.getItem('ggui_colors');
        if (s) return { ...DEFAULT_COLORS, ...JSON.parse(s) };
    } catch(e) {}
    return { ...DEFAULT_COLORS };
}
let COLOR_HEX = loadColors();

function hexToRgb(hex) {
    return [
        parseInt(hex.slice(1,3),16)/255,
        parseInt(hex.slice(3,5),16)/255,
        parseInt(hex.slice(5,7),16)/255
    ];
}

function getColor(key) {
    if (key.startsWith('D3.')) return hexToRgb(COLOR_HEX['desenhos']);
    if (key.startsWith('P4.')) return hexToRgb(COLOR_HEX['projetos']);
    return hexToRgb(COLOR_HEX[key] || DEFAULT_COLORS['ctas']);
}

// =============================================
// WEBGL SHADER
// =============================================
const canvas = document.getElementById('bg-canvas');
const gl = canvas.getContext('webgl');

const vertSrc = `
    attribute vec2 a_pos; attribute vec2 a_uv; varying vec2 v_uv;
    uniform float u_t;
    uniform float u_ar; /* aspect ratio width/height */
    uniform float u_w1a,u_w1f,u_w2a,u_w2f,u_w3a,u_w3f;
    void main() {
        v_uv = a_uv; vec2 p = a_pos * 1.4;
        /* normaliza p para espaÃ§o "16:9 equivalente" antes de calcular ondas */
        /* assim as ondas tÃªm sempre a mesma densidade visual independente do AR */
        float targetAR = 16.0 / 9.0;
        float scale = u_ar / targetAR; /* >1 em telas largas, <1 em portrait */
        vec2 pn = vec2(p.x * min(scale, 1.0), p.y * min(1.0 / scale, 1.0));
        float w = u_w1a*sin(u_w1f*pn.x+u_t*1.0)
                + u_w2a*cos(u_w2f*pn.y+u_t*0.7)
                + u_w3a*sin(u_w3f*(pn.x+pn.y)+u_t*0.5);
        p.y+=w; p.x+=w*0.5;
        gl_Position=vec4(p,0.0,1.0);
    }
`;
const fragSrc = `
    precision highp float; varying vec2 v_uv; uniform float u_t;
    uniform vec3 u_sc,u_tc; uniform float u_tp;
    float rnd(vec2 s){return fract(sin(dot(s,vec2(12.9898,78.233)))*43758.5453);}
    void main() {
        vec3 dark=vec3(0.031);
        float w=0.5*sin(u_t*0.7+v_uv.x*6.0)+0.3*cos(u_t*0.9+v_uv.y*8.0)+0.2*sin(u_t*0.5+(v_uv.x+v_uv.y)*10.0);
        float val=sin(w*0.5+v_uv.x*2.0-v_uv.y*2.0);
        vec3 col=mix(u_sc,u_tc,u_tp);
        vec3 c1=mix(dark,col,smoothstep(-0.5,10.0,val));
        vec3 c2=mix(dark,col,smoothstep(-0.5,0.3,val));
        vec3 final=mix(c2,c1,smoothstep(0.1,0.7,val)*0.9);
        final+=vec3(rnd(v_uv*(u_t*0.1+1.0))*0.06);
        gl_FragColor=vec4(final,1.0);
    }
`;

function mkSh(type,src){const s=gl.createShader(type);gl.shaderSource(s,src);gl.compileShader(s);return s;}
const prog=gl.createProgram();
gl.attachShader(prog,mkSh(gl.VERTEX_SHADER,vertSrc));
gl.attachShader(prog,mkSh(gl.FRAGMENT_SHADER,fragSrc));
gl.linkProgram(prog); gl.useProgram(prog);

const G=100; const vPos=[],vUV=[],vIdx=[];
for(let y=0;y<=G;y++) for(let x=0;x<=G;x++){vPos.push(x/G*2-1,y/G*2-1);vUV.push(x/G,y/G);}
for(let y=0;y<G;y++) for(let x=0;x<G;x++){
    const i=y*(G+1)+x;
    vIdx.push(i,i+1,i+G+1,i+1,i+G+2,i+G+1);
}

function mkBuf(t,d,C){const b=gl.createBuffer();gl.bindBuffer(t,b);gl.bufferData(t,new C(d),gl.STATIC_DRAW);return b;}
const pB=mkBuf(gl.ARRAY_BUFFER,vPos,Float32Array);
const uB=mkBuf(gl.ARRAY_BUFFER,vUV,Float32Array);
const iB=mkBuf(gl.ELEMENT_ARRAY_BUFFER,vIdx,Uint16Array);

function bindA(buf,name,size){
    const loc=gl.getAttribLocation(prog,name);
    gl.bindBuffer(gl.ARRAY_BUFFER,buf);
    gl.enableVertexAttribArray(loc);
    gl.vertexAttribPointer(loc,size,gl.FLOAT,false,0,0);
}
bindA(pB,'a_pos',2); bindA(uB,'a_uv',2);

const uT =gl.getUniformLocation(prog,'u_t');
const uAR=gl.getUniformLocation(prog,'u_ar');
const uSC=gl.getUniformLocation(prog,'u_sc');
const uTC=gl.getUniformLocation(prog,'u_tc');
const uTP=gl.getUniformLocation(prog,'u_tp');
const uWs=['u_w1a','u_w1f','u_w2a','u_w2f','u_w3a','u_w3f'].map(n=>gl.getUniformLocation(prog,n));

function resize(){
    const r=devicePixelRatio||1;
    canvas.width=innerWidth*r; canvas.height=innerHeight*r;
    gl.viewport(0,0,canvas.width,canvas.height);
}
addEventListener('resize',resize); resize();

// --- ESTADO DA TRANSIÃ‡ÃƒO ---
let sSt = hexToRgb(DEFAULT_COLORS.ctas);
let sTgt = hexToRgb(DEFAULT_COLORS.ctas);
let sTP = 1.0, sTStart = 0;
const TRANS = 1600;
let sTime = 0, lastTS = 0;

function eio(t) { return 0.5 - 0.5 * Math.cos(Math.PI * t); }

// Retorna a cor visual atual (interpolada no ponto exato onde o shader estÃ¡)
function currentColor() {
    const ep = eio(Math.min(sTP, 1.0));
    return sSt.map((s, i) => s + (sTgt[i] - s) * ep);
}

// FIX: sempre parte da cor visual atual â€” sem pulo, sem pisca
function triggerColor(key) {
    const col = getColor(key);
    if (col.every((v, i) => Math.abs(v - sTgt[i]) < 0.004)) return;
    sSt = currentColor(); // â† captura onde estÃ¡ agora, nÃ£o o destino anterior
    sTgt = col;
    sTP = 0;
    sTStart = performance.now();
}

(function loop(ts){
    requestAnimationFrame(loop);
    const dt=(ts-lastTS)/1000; lastTS=ts; sTime+=dt*0.4;
    if(sTP<1.0){
        sTP=Math.min((ts-sTStart)/TRANS,1.0);
        if(sTP>=1.0) sSt=[...sTgt];
    }
    const ep=eio(Math.min(sTP,1.0));
    gl.clearColor(0.04,0.04,0.04,1); gl.clear(gl.COLOR_BUFFER_BIT);
    gl.uniform1f(uT,sTime);
    gl.uniform1f(uAR, canvas.width / canvas.height);
    gl.uniform3f(uSC,sSt[0],sSt[1],sSt[2]);
    gl.uniform3f(uTC,sTgt[0],sTgt[1],sTgt[2]);
    gl.uniform1f(uTP,ep);
    [0.25,4.0,0.05,13.0,0.02,8.0].forEach((v,i)=>gl.uniform1f(uWs[i],v));
    gl.bindBuffer(gl.ELEMENT_ARRAY_BUFFER,iB);
    gl.drawElements(gl.TRIANGLES,vIdx.length,gl.UNSIGNED_SHORT,0);
})(0);

// =============================================
// DETECÃ‡ÃƒO DE CENTRO DA TELA (scroll-based)
// =============================================
let centerKey = 'ctas';

function detectCenter() {
    const mid = window.innerHeight / 2;
    let best = null, bestDist = Infinity;

    function check(el, key) {
        if (!el) return;
        const r = el.getBoundingClientRect();
        const dist = Math.abs((r.top + r.bottom) / 2 - mid);
        if (dist < bestDist) { bestDist = dist; best = key; }
    }

    check(document.getElementById('sobre-mim'), 'ctas');

    document.querySelectorAll('#timeline [data-item-key]').forEach(el => {
        check(el, el.dataset.itemKey);
    });

    const area = document.getElementById('candidate-area');
    if (area.children.length && area.dataset.currentKey) {
        check(area, area.dataset.currentKey);
    }

    if (best && best !== centerKey) {
        centerKey = best;
        triggerColor(best);
    }
}

window.addEventListener('scroll', detectCenter, { passive: true });
setInterval(detectCenter, 200);

// =============================================
// GGUI ENGINE
// =============================================
const LIVE = {
    get decay(){ return parseInt(document.getElementById('cfg-decay').value) },
    get speed(){ return parseFloat(document.getElementById('cfg-speed').value) },
    get share(){ return parseInt(document.getElementById('cfg-share').value) }
};

const templates = {
    ctas: {
        "CONTATOS": `<div class="instancia-container cta-inst"><div class="cta-display">
            <div class="cta-eyebrow">Contato</div>
            <h2>Onde encontrar<br>wayne?</h2>
            <div class="cta-sub">Aberto pra projetos, collabs<br>e conversas interessantes.</div>
            <div class="cta-links">
                <a href="#">LinkedIn</a>
                <a href="#">GitHub</a>
                <a href="#">Spotify</a>
            </div>
        </div></div>`,

        "GO_DESENHOS": `<div class="instancia-container cta-inst"><div class="cta-display">
            <div class="cta-eyebrow">Sketchbook</div>
            <h2>Quer ver<br>umas artes?</h2>
            <div class="cta-sub">SÃ³ rabiscada descompromissada<br>e antiga (um dia eu upo tudo)</div>
            <button class="cta-action" onclick="injectIntent('desenhos')">
                <span>Focar</span><span class="arr">â†’</span>
            </button>
        </div></div>`,

        "GO_PROJETOS": `<div class="instancia-container cta-inst"><div class="cta-display">
            <div class="cta-eyebrow">Portfolio</div>
            <h2>Quer ver<br>cases?</h2>
            <div class="cta-sub">Cases de sistemas, design ux, produtos digitais, jogos, e outras coisas<br>(inclusive essa experiÃªncia aqui)</div>
            <button class="cta-action" onclick="injectIntent('projetos')">
                <span>Focar</span><span class="arr">â†’</span>
            </button>
        </div></div>`
    },
    desenhos: {}, projetos: {}
};
for(let i=1;i<=5;i++){
    templates.desenhos[`D3.${i}`]=`<div class="instancia-container"><div class="art-card">
        <div class="art-placeholder">
            <span class="art-id">ART â€” 3.${i}</span>
        </div>
    </div></div>`;

    templates.projetos[`P4.${i}`]=`<div class="instancia-container"><div class="proj-card">
        <div class="proj-media">
            <div class="media-label">
                <div class="media-icon">â–¶</div>
            </div>
        </div>
        <div class="proj-info">
            <div class="proj-eyebrow">PROJ â€” 4.${i}</div>
            <h3>Case de Sistema ${i}</h3>
            <p>Placeholder â€” descreva aqui a intenÃ§Ã£o do projeto, o problema que ele resolve e as decisÃµes que tornaram a soluÃ§Ã£o possÃ­vel.</p>
        </div>
    </div></div>`;
}

let state={
    targetWeights:{}, currentWeights:{},
    focusGroup:'ctas', lastDecayTime:Date.now(),
    last:null, isLocked:false, currentCandidate:null
};

function init(){
    Object.keys(templates).forEach(g=>
        Object.keys(templates[g]).forEach(item=>{
            state.currentWeights[item]=0; state.targetWeights[item]=0;
        })
    );
    calculateTargets('ctas'); runEngine();
}

function calculateTargets(focus){
    state.focusGroup=focus; state.lastDecayTime=Date.now();
    const groups=Object.keys(templates);
    groups.forEach(g=>{
        const share=(g===focus)?LIVE.share:(100-LIVE.share)/(groups.length-1);
        const items=Object.keys(templates[g]);
        items.forEach(item=>{ state.targetWeights[item]=share/items.length; });
    });
}

setInterval(()=>{
    Object.keys(state.currentWeights).forEach(key=>{
        const d=state.targetWeights[key]-state.currentWeights[key];
        if(Math.abs(d)>0.01) state.currentWeights[key]+=Math.sign(d)*Math.min(Math.abs(d),LIVE.speed);
    });
    updateMonitor();
},50);

function runEngine(){
    if(state.isLocked) return;
    let pool=Object.keys(state.currentWeights).filter(k=>k!==state.last);
    if(state.focusGroup==='desenhos') pool=pool.filter(k=>k!=='GO_DESENHOS');
    if(state.focusGroup==='projetos') pool=pool.filter(k=>k!=='GO_PROJETOS');
    const total=pool.reduce((a,k)=>a+state.currentWeights[k],0);
    if(total<=0) return;
    let rand=Math.random()*total, sel=pool[0];
    for(const key of pool){ if(rand<state.currentWeights[key]){sel=key;break;} rand-=state.currentWeights[key]; }
    state.currentCandidate=sel;
    document.getElementById('next-label').innerText=sel;

    const area=document.getElementById('candidate-area');
    area.dataset.currentKey=sel;
    for(const g in templates){
        if(templates[g][sel]){ area.innerHTML=templates[g][sel]; break; }
    }
    setTimeout(detectCenter, 50);
}

function injectIntent(group){
    calculateTargets(group);
    const items=Object.keys(templates[group]);
    const share=LIVE.share/items.length;
    items.forEach(item=>{ state.currentWeights[item]=share; });
    Object.keys(state.currentWeights).forEach(k=>{ if(!items.includes(k)) state.currentWeights[k]=0; });
    // Garante que o prÃ³ximo candidato Ã© do novo foco
    state.last = null;
    const firstItem = items[Math.floor(Math.random()*items.length)];
    state.currentCandidate = firstItem;
    document.getElementById('next-label').innerText = firstItem;
    const area = document.getElementById('candidate-area');
    area.dataset.currentKey = firstItem;
    area.innerHTML = templates[group][firstItem];
    setTimeout(detectCenter, 50);
    window.scrollBy({top:150,behavior:'smooth'});
}

function commit(){
    state.isLocked=true;
    const item=state.currentCandidate;
    state.last=item; state.currentWeights[item]=0;
    const area=document.getElementById('candidate-area');
    const div=document.createElement('div');
    div.className='commited';
    div.dataset.itemKey=item;
    div.innerHTML=area.innerHTML;
    document.getElementById('timeline').appendChild(div);
    area.innerHTML=''; area.dataset.currentKey='';
    setTimeout(()=>{ state.isLocked=false; runEngine(); },500);
}

setInterval(()=>{
    if(state.focusGroup!=='ctas'){
        const rem=Math.max(0,(LIVE.decay-(Date.now()-state.lastDecayTime))/1000);
        document.getElementById('decay-timer').innerText=rem.toFixed(1);
        if(rem<=0) calculateTargets('ctas');
    } else { document.getElementById('decay-timer').innerText='--'; }
},100);

window.addEventListener('scroll',()=>{
    const area=document.getElementById('candidate-area');
    if(!area.children.length||state.isLocked) return;
    if(area.getBoundingClientRect().top<window.innerHeight-150) commit();
});

function updateMonitor(){
    document.getElementById('current-focus').innerText=state.focusGroup.toUpperCase();
    document.getElementById('prob-list').innerHTML=Object.entries(state.currentWeights)
        .sort((a,b)=>b[1]-a[1]).slice(0,6)
        .map(([k,v])=>`
            <div style="margin-bottom:7px">
                <div style="display:flex;justify-content:space-between;opacity:0.8"><span>${k}</span><span>${v.toFixed(1)}%</span></div>
                <div style="width:100%;height:2px;background:rgba(255,255,255,0.08);border-radius:2px;margin-top:3px">
                    <div class="bar-fill" style="width:${Math.min(v*2,100)}%"></div>
                </div>
            </div>`).join('');
}

init();
setInterval(runEngine,400);

// =============================================
// COLOR MODAL
// =============================================
function openColorModal(){
    Object.keys(DEFAULT_COLORS).forEach(key=>{
        const el=document.getElementById('col-'+key);
        if(el) el.value=COLOR_HEX[key]||DEFAULT_COLORS[key];
    });
    document.getElementById('color-modal-overlay').classList.add('open');
}

// FIX: live preview parte da cor atual interpolada, nÃ£o reseta centerKey
document.getElementById('color-modal-overlay').addEventListener('input',e=>{
    if(e.target.type!=='color') return;
    const key=e.target.id.replace('col-','');
    COLOR_HEX[key]=e.target.value;
    // ForÃ§a transiÃ§Ã£o suave da cor atual para a nova cor do centerKey
    const col = getColor(centerKey);
    sSt = currentColor();  // â† captura visual atual antes de mudar sTgt
    sTgt = col;
    sTP = 0;
    sTStart = performance.now();
});

function closeModal(){
    localStorage.setItem('ggui_colors', JSON.stringify(COLOR_HEX));
    document.getElementById('color-modal-overlay').classList.remove('open');
}

document.getElementById('btn-close-modal').addEventListener('click', closeModal);
document.getElementById('color-modal-overlay').addEventListener('click',e=>{
    if(e.target===document.getElementById('color-modal-overlay')) closeModal();
});

document.getElementById('btn-copy-colors').addEventListener('click',()=>{
    const lines=Object.entries(COLOR_HEX).map(([k,v])=>`    '${k}': '${v}',`).join('\n');
    const code=`const DEFAULT_COLORS = {\n${lines}\n};`;
    navigator.clipboard.writeText(code).then(()=>{
        const fb=document.getElementById('copy-feedback');
        fb.classList.add('show');
        setTimeout(()=>fb.classList.remove('show'),2200);
    });
});
</script>
</body>
</html>
